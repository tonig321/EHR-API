AWSTemplateFormatVersion: '2010-09-09'
Description: 'AthenaHealth API Integration with RDS - HIPAA Compliant Extension'

Parameters:
  EnvironmentName:
    Description: Environment name prefix
    Type: String
    Default: 'gov-health'
  
  VPCId:
    Description: VPC ID from foundation stack
    Type: String
  
  PrivateSubnet1Id:
    Description: Private Subnet 1 ID from foundation stack
    Type: String
  
  PrivateSubnet2Id:
    Description: Private Subnet 2 ID from foundation stack
    Type: String
  
  KMSKeyId:
    Description: KMS Key ID from foundation stack
    Type: String
  
  DBMasterUsername:
    Description: Master username for RDS instance
    Type: String
    Default: 'healthadmin'
    MinLength: 1
    MaxLength: 16
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
  
  DBInstanceClass:
    Description: RDS instance class
    Type: String
    Default: 'db.t3.medium'
    AllowedValues:
      - db.t3.micro
      - db.t3.small
      - db.t3.medium
      - db.t3.large
      - db.r5.large
      - db.r5.xlarge

Resources:
  # RDS Subnet Group
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: !Sub '${EnvironmentName}-db-subnet-group'
      DBSubnetGroupDescription: 'Subnet group for HIPAA-compliant RDS'
      SubnetIds:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-db-subnet-group'

  # RDS Security Group
  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${EnvironmentName}-rds-sg'
      GroupDescription: 'Security group for RDS PostgreSQL'
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: 'PostgreSQL access from Lambda functions'
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-rds-sg'

  # Lambda Security Group
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${EnvironmentName}-lambda-sg'
      GroupDescription: 'Security group for Lambda functions'
      VpcId: !Ref VPCId
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          DestinationSecurityGroupId: !Ref RDSSecurityGroup
          Description: 'PostgreSQL access to RDS'
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: 'HTTPS outbound for API calls'
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-lambda-sg'

  # Secrets Manager for Database Password
  DBPasswordSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${EnvironmentName}/rds/password'
      Description: 'RDS PostgreSQL master password'
      GenerateSecretString:
        SecretStringTemplate: !Sub '{"username": "${DBMasterUsername}"}'
        GenerateStringKey: 'password'
        PasswordLength: 32
        ExcludeCharacters: '"@/\'
      KmsKeyId: !Ref KMSKeyId

  # Secrets Manager for AthenaHealth API Credentials
  AthenaHealthAPISecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${EnvironmentName}/athenahealth/api'
      Description: 'AthenaHealth API credentials'
      SecretString: !Sub |
        {
          "client_id": "REPLACE_WITH_YOUR_CLIENT_ID",
          "client_secret": "REPLACE_WITH_YOUR_CLIENT_SECRET",
          "api_base_url": "https://api.platform.athenahealth.com",
          "sandbox_url": "https://api.platform.athenahealth.com"
        }
      KmsKeyId: !Ref KMSKeyId

  # RDS PostgreSQL Instance
  PostgreSQLDatabase:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub '${EnvironmentName}-postgresql'
      DBInstanceClass: !Ref DBInstanceClass
      Engine: postgres
      EngineVersion: '15.4'
      AllocatedStorage: 100
      StorageType: gp3
      StorageEncrypted: true
      KmsKeyId: !Ref KMSKeyId
      MasterUsername: !Ref DBMasterUsername
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${DBPasswordSecret}:SecretString:password}}'
      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      BackupRetentionPeriod: 30
      PreferredBackupWindow: '03:00-04:00'
      PreferredMaintenanceWindow: 'sun:04:00-sun:05:00'
      MultiAZ: true
      PubliclyAccessible: false
      DeletionProtection: true
      EnablePerformanceInsights: true
      PerformanceInsightsKMSKeyId: !Ref KMSKeyId
      PerformanceInsightsRetentionPeriod: 7
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-postgresql'
        - Key: Environment
          Value: !Ref EnvironmentName

  # Lambda Execution Role
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${EnvironmentName}-lambda-execution-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole'
      Policies:
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'secretsmanager:GetSecretValue'
                  - 'secretsmanager:DescribeSecret'
                Resource:
                  - !Ref DBPasswordSecret
                  - !Ref AthenaHealthAPISecret
              - Effect: Allow
                Action:
                  - 'kms:Decrypt'
                  - 'kms:DescribeKey'
                Resource: !Sub 'arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/${KMSKeyId}'
        - PolicyName: RDSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'rds-db:connect'
                Resource: !Sub 'arn:aws:rds-db:${AWS::Region}:${AWS::AccountId}:dbuser:${PostgreSQLDatabase}/${DBMasterUsername}'
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*'

  # VPC Endpoint for Secrets Manager
  SecretsManagerVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.secretsmanager'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  # VPC Endpoint Security Group
  VPCEndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${EnvironmentName}-vpce-sg'
      GroupDescription: 'Security group for VPC Endpoints'
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: 'HTTPS from Lambda'
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-vpce-sg'

  # Lambda Function - Inbound (AthenaHealth API to RDS)
  InboundLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${EnvironmentName}-athena-inbound'
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 512
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1Id
          - !Ref PrivateSubnet2Id
      Environment:
        Variables:
          DB_SECRET_ARN: !Ref DBPasswordSecret
          API_SECRET_ARN: !Ref AthenaHealthAPISecret
          DB_ENDPOINT: !GetAtt PostgreSQLDatabase.Endpoint.Address
          DB_NAME: 'healthdb'
          DB_PORT: '5432'
      Code:
        ZipFile: |
          import json
          import boto3
          import psycopg2
          import os
          from botocore.exceptions import ClientError
          
          def lambda_handler(event, context):
              """
              Lambda function to pull data from AthenaHealth API and store in RDS
              """
              try:
                  # Get secrets
                  db_credentials = get_secret(os.environ['DB_SECRET_ARN'])
                  api_credentials = get_secret(os.environ['API_SECRET_ARN'])
                  
                  # Parse database credentials
                  db_creds = json.loads(db_credentials)
                  
                  # Connect to RDS PostgreSQL
                  conn = psycopg2.connect(
                      host=os.environ['DB_ENDPOINT'],
                      port=os.environ['DB_PORT'],
                      database=os.environ['DB_NAME'],
                      user=db_creds['username'],
                      password=db_creds['password']
                  )
                  
                  cursor = conn.cursor()
                  
                  # TODO: Implement AthenaHealth API call logic here
                  # TODO: Transform and insert data into RDS
                  
                  cursor.close()
                  conn.commit()
                  conn.close()
                  
                  return {
                      'statusCode': 200,
                      'body': json.dumps('Data successfully processed')
                  }
              
              except Exception as e:
                  print(f"Error: {str(e)}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Error processing data: {str(e)}')
                  }
          
          def get_secret(secret_arn):
              """Retrieve secret from Secrets Manager"""
              client = boto3.client('secretsmanager')
              try:
                  response = client.get_secret_value(SecretId=secret_arn)
                  return response['SecretString']
              except ClientError as e:
                  raise e
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-athena-inbound'

  # Lambda Function - Outbound (RDS to AthenaHealth API)
  OutboundLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${EnvironmentName}-athena-outbound'
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 512
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1Id
          - !Ref PrivateSubnet2Id
      Environment:
        Variables:
          DB_SECRET_ARN: !Ref DBPasswordSecret
          API_SECRET_ARN: !Ref AthenaHealthAPISecret
          DB_ENDPOINT: !GetAtt PostgreSQLDatabase.Endpoint.Address
          DB_NAME: 'healthdb'
          DB_PORT: '5432'
      Code:
        ZipFile: |
          import json
          import boto3
          import psycopg2
          import os
          from botocore.exceptions import ClientError
          
          def lambda_handler(event, context):
              """
              Lambda function to read data from RDS and send to AthenaHealth API
              """
              try:
                  # Get secrets
                  db_credentials = get_secret(os.environ['DB_SECRET_ARN'])
                  api_credentials = get_secret(os.environ['API_SECRET_ARN'])
                  
                  # Parse database credentials
                  db_creds = json.loads(db_credentials)
                  
                  # Connect to RDS PostgreSQL
                  conn = psycopg2.connect(
                      host=os.environ['DB_ENDPOINT'],
                      port=os.environ['DB_PORT'],
                      database=os.environ['DB_NAME'],
                      user=db_creds['username'],
                      password=db_creds['password']
                  )
                  
                  cursor = conn.cursor()
                  
                  # TODO: Query data from RDS
                  # TODO: Transform and send to AthenaHealth API
                  
                  cursor.close()
                  conn.close()
                  
                  return {
                      'statusCode': 200,
                      'body': json.dumps('Data successfully sent to AthenaHealth')
                  }
              
              except Exception as e:
                  print(f"Error: {str(e)}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Error sending data: {str(e)}')
                  }
          
          def get_secret(secret_arn):
              """Retrieve secret from Secrets Manager"""
              client = boto3.client('secretsmanager')
              try:
                  response = client.get_secret_value(SecretId=secret_arn)
                  return response['SecretString']
              except ClientError as e:
                  raise e
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-athena-outbound'

  # Lambda Function - Data Transformation
  TransformLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${EnvironmentName}-data-transform'
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 1024
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1Id
          - !Ref PrivateSubnet2Id
      Environment:
        Variables:
          DB_SECRET_ARN: !Ref DBPasswordSecret
          DB_ENDPOINT: !GetAtt PostgreSQLDatabase.Endpoint.Address
          DB_NAME: 'healthdb'
          DB_PORT: '5432'
      Code:
        ZipFile: |
          import json
          import boto3
          import psycopg2
          import os
          from botocore.exceptions import ClientError
          
          def lambda_handler(event, context):
              """
              Lambda function for data transformation operations
              """
              try:
                  # Get database credentials
                  db_credentials = get_secret(os.environ['DB_SECRET_ARN'])
                  db_creds = json.loads(db_credentials)
                  
                  # Connect to RDS PostgreSQL
                  conn = psycopg2.connect(
                      host=os.environ['DB_ENDPOINT'],
                      port=os.environ['DB_PORT'],
                      database=os.environ['DB_NAME'],
                      user=db_creds['username'],
                      password=db_creds['password']
                  )
                  
                  cursor = conn.cursor()
                  
                  # TODO: Implement data transformation logic
                  
                  cursor.close()
                  conn.commit()
                  conn.close()
                  
                  return {
                      'statusCode': 200,
                      'body': json.dumps('Data transformation completed')
                  }
              
              except Exception as e:
                  print(f"Error: {str(e)}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Transformation error: {str(e)}')
                  }
          
          def get_secret(secret_arn):
              """Retrieve secret from Secrets Manager"""
              client = boto3.client('secretsmanager')
              try:
                  response = client.get_secret_value(SecretId=secret_arn)
                  return response['SecretString']
              except ClientError as e:
                  raise e
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-data-transform'

  # API Gateway REST API
  HealthAPIGateway:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub '${EnvironmentName}-health-api'
      Description: 'Internal API Gateway for AthenaHealth integration'
      EndpointConfiguration:
        Types:
          - PRIVATE
        VpcEndpointIds:
          - !Ref APIGatewayVPCEndpoint

  # API Gateway VPC Endpoint
  APIGatewayVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.execute-api'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  # API Gateway Resource - Inbound
  InboundAPIResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref HealthAPIGateway
      ParentId: !GetAtt HealthAPIGateway.RootResourceId
      PathPart: 'inbound'

  # API Gateway Method - Inbound POST
  InboundAPIMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref HealthAPIGateway
      ResourceId: !Ref InboundAPIResource
      HttpMethod: POST
      AuthorizationType: AWS_IAM
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${InboundLambdaFunction.Arn}/invocations'

  # API Gateway Resource - Outbound
  OutboundAPIResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref HealthAPIGateway
      ParentId: !GetAtt HealthAPIGateway.RootResourceId
      PathPart: 'outbound'

  # API Gateway Method - Outbound POST
  OutboundAPIMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref HealthAPIGateway
      ResourceId: !Ref OutboundAPIResource
      HttpMethod: POST
      AuthorizationType: AWS_IAM
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${OutboundLambdaFunction.Arn}/invocations'

  # API Gateway Deployment
  APIDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - InboundAPIMethod
      - OutboundAPIMethod
    Properties:
      RestApiId: !Ref HealthAPIGateway
      StageName: 'prod'

  # Lambda Permission for API Gateway - Inbound
  InboundLambdaAPIPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref InboundLambdaFunction
      Action: 'lambda:InvokeFunction'
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${HealthAPIGateway}/*/*'

  # Lambda Permission for API Gateway - Outbound
  OutboundLambdaAPIPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref OutboundLambdaFunction
      Action: 'lambda:InvokeFunction'
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${HealthAPIGateway}/*/*'

  # CloudWatch Log Group for Lambda - Inbound
  InboundLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${InboundLambdaFunction}'
      RetentionInDays: 30
      KmsKeyId: !Sub 'arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/${KMSKeyId}'

  # CloudWatch Log Group for Lambda - Outbound
  OutboundLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${OutboundLambdaFunction}'
      RetentionInDays: 30
      KmsKeyId: !Sub 'arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/${KMSKeyId}'

  # CloudWatch Log Group for Lambda - Transform
  TransformLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${TransformLambdaFunction}'
      RetentionInDays: 30
      KmsKeyId: !Sub 'arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/${KMSKeyId}'

Outputs:
  RDSEndpoint:
    Description: 'RDS PostgreSQL endpoint'
    Value: !GetAtt PostgreSQLDatabase.Endpoint.Address
    Export:
      Name: !Sub '${EnvironmentName}-rds-endpoint'

  RDSPort:
    Description: 'RDS PostgreSQL port'
    Value: !GetAtt PostgreSQLDatabase.Endpoint.Port
    Export:
      Name: !Sub '${EnvironmentName}-rds-port'

  DBSecretArn:
    Description: 'ARN of the database credentials secret'
    Value: !Ref DBPasswordSecret
    Export:
      Name: !Sub '${EnvironmentName}-db-secret-arn'

  APISecretArn:
    Description: 'ARN of the AthenaHealth API credentials secret'
    Value: !Ref AthenaHealthAPISecret
    Export:
      Name: !Sub '${EnvironmentName}-api-secret-arn'

  InboundLambdaArn:
    Description: 'ARN of the Inbound Lambda function'
    Value: !GetAtt InboundLambdaFunction.Arn
    Export:
      Name: !Sub '${EnvironmentName}-inbound-lambda-arn'

  OutboundLambdaArn:
    Description: 'ARN of the Outbound Lambda function'
    Value: !GetAtt OutboundLambdaFunction.Arn
    Export:
      Name: !Sub '${EnvironmentName}-outbound-lambda-arn'

  TransformLambdaArn:
    Description: 'ARN of the Transform Lambda function'
    Value: !GetAtt TransformLambdaFunction.Arn
    Export:
      Name: !Sub '${EnvironmentName}-transform-lambda-arn'

  APIGatewayId:
    Description: 'ID of the API Gateway'
    Value: !Ref HealthAPIGateway
    Export:
      Name: !Sub '${EnvironmentName}-api-gateway-id'

  APIGatewayEndpoint:
    Description: 'API Gateway invoke URL'
    Value: !Sub 'https://${HealthAPIGateway}.execute-api.${AWS::Region}.amazonaws.com/prod'
    Export:
      Name: !Sub '${EnvironmentName}-api-gateway-endpoint'
